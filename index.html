<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>SettleUp â€“ Free Expense Splitter</title>
  <meta name="description" content="Free expense splitter to fairly split bills and settle group expenses instantly.">

  <style>
    :root {
      --bg:#f5f5f5;
      --card:#fff;
      --text:#111;
      --accent:#2563eb;
      --border:#ddd;
      --toast:#111;
    }

    body.dark {
      --bg:#0f172a;
      --card:#1e293b;
      --text:#e5e7eb;
      --accent:#60a5fa;
      --border:#334155;
      --toast:#0f172a;
    }

    * { box-sizing: border-box; }

    body {
      margin:0;
      font-family: system-ui, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .container {
      max-width:720px;
      margin:auto;
      padding:20px;
    }

    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    h1 { font-size:1.4rem; }

    button {
      background:var(--accent);
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
    }

    button.secondary {
      background:transparent;
      color:var(--accent);
      border:1px solid var(--accent);
    }

    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      margin-top:16px;
    }

    .form {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    input {
      flex:1;
      padding:8px;
      border-radius:6px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
    }

    .list-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:8px;
      gap:8px;
    }

    .actions button {
      padding:4px 8px;
      font-size:.8rem;
    }

    ul { padding-left:20px; }

    #qr { margin-top:12px; text-align:center; }

    /* ---------- Toast ---------- */
    .toast {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:var(--toast);
      color:#fff;
      padding:10px 16px;
      border-radius:8px;
      opacity:0;
      pointer-events:none;
      transition:opacity .3s, transform .3s;
    }

    .toast.show {
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }

    @media(max-width:600px){
      .form { flex-direction:column; }
    }
  </style>
</head>

<body>
  <div class="container">

    <header>
      <h1>ðŸ’¸ SettleUp</h1>
      <button class="secondary" onclick="toggleDark()">ðŸŒ™</button>
    </header>

    <div class="card">
      <div class="form">
        <input id="name" placeholder="Name" />
        <input id="amount" type="number" placeholder="Paid" />
        <button onclick="addPerson()">Add</button>
      </div>
    </div>

    <div class="card" id="peopleList">
      <h3>People</h3>
    </div>

    <div class="card">
      <button onclick="calculate()">Calculate</button>
      <button class="secondary" onclick="copyLink()">Share</button>
      <button class="secondary" onclick="generateQR()">QR</button>
      <div id="output"></div>
      <div id="qr"></div>
    </div>

  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* ---------- State ---------- */
    let people = [];
    let editIndex = null;

    const nameInput = document.getElementById("name");
    const amountInput = document.getElementById("amount");
    const peopleList = document.getElementById("peopleList");
    const output = document.getElementById("output");
    const qr = document.getElementById("qr");
    const toast = document.getElementById("toast");

    /* ---------- Helpers ---------- */
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2500);
    }

    function normalizeName(name) {
      // Latin letters only â†’ capitalize
      if (/^[a-zA-Z]/.test(name)) {
        return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
      }
      return name;
    }

    function compareNames(a, b) {
      return a.toLowerCase() === b.toLowerCase();
    }

    /* ---------- Dark Mode ---------- */
    function toggleDark() {
      document.body.classList.toggle("dark");
      localStorage.setItem("dark", document.body.classList.contains("dark"));
    }

    if (localStorage.getItem("dark") === "true") toggleDark();

    /* ---------- URL State ---------- */
    function encodeState() {
      location.hash = "data=" + btoa(JSON.stringify({ people }));
    }

    function decodeState() {
      if (!location.hash.startsWith("#data=")) return;
      try {
        const decoded = JSON.parse(atob(location.hash.slice(6)));
        if (decoded.people) {
          people = decoded.people;
          render();
          calculate();
        }
      } catch {}
    }

    decodeState();

    /* ---------- CRUD ---------- */
    function addPerson() {
      let name = nameInput.value.trim();
      const amount = parseFloat(amountInput.value);

      if (!name || isNaN(amount)) return;

      name = normalizeName(name);

      const existingIndex = people.findIndex(p =>
        compareNames(p.name, name)
      );

      if (editIndex !== null) {
        people[editIndex] = { name, amount };
        editIndex = null;
      } else if (existingIndex !== -1) {
        people[existingIndex].amount = amount;
        showToast(`"${name}" already exists â€” amount updated`);
      } else {
        people.push({ name, amount });
      }

      nameInput.value = "";
      amountInput.value = "";

      render();
      encodeState();
      calculate();
    }

    function editPerson(i) {
      nameInput.value = people[i].name;
      amountInput.value = people[i].amount;
      editIndex = i;
    }

    function deletePerson(i) {
      people.splice(i, 1);
      render();
      encodeState();
      calculate();
    }

    /* ---------- Render ---------- */
    function render() {
      peopleList.innerHTML = "<h3>People</h3>";
      people.forEach((p, i) => {
        peopleList.innerHTML += `
          <div class="list-item">
            <span>${p.name} â€” ${p.amount}</span>
            <div class="actions">
              <button class="secondary" onclick="editPerson(${i})">Edit</button>
              <button onclick="deletePerson(${i})">Delete</button>
            </div>
          </div>
        `;
      });
    }

    /* ---------- Calculation ---------- */
    function calculate() {
      if (!people.length) return;

      const total = people.reduce((s, p) => s + p.amount, 0);
      const share = +(total / people.length).toFixed(2);

      let balances = people.map(p => ({
        name: p.name,
        b: +(p.amount - share).toFixed(2)
      }));

      let creditors = balances.filter(x => x.b > 0);
      let debtors = balances
        .filter(x => x.b < 0)
        .map(x => ({ name: x.name, b: -x.b }));

      let i = 0, j = 0, tx = [];

      while (i < debtors.length && j < creditors.length) {
        const amt = Math.min(debtors[i].b, creditors[j].b);

        tx.push(
          `${debtors[i].name}  â†’  ${creditors[j].name}  :  ${amt.toFixed(2)}`
        );

        debtors[i].b -= amt;
        creditors[j].b -= amt;

        if (debtors[i].b === 0) i++;
        if (creditors[j].b === 0) j++;
      }

      output.innerHTML = `
        <p><strong>Each pays:</strong> ${share}</p>
        <h4>Transactions</h4>
        ${
          tx.length
            ? `<ul>${tx.map(t => `<li>${t}</li>`).join("")}</ul>`
            : "None"
        }
      `;
    }

    /* ---------- Share ---------- */
    function copyLink() {
      navigator.clipboard.writeText(location.href);
      showToast("Link copied to clipboard");
    }

    /* ---------- QR ---------- */
    function generateQR() {
      qr.innerHTML = `
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(location.href)}">
        <p>Scan to open</p>
      `;
    }
  </script>
</body>
</html>