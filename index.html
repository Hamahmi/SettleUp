<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>SettleUp ‚Äì Expense Splitter</title>
  <meta name="description" content="Free expense splitter to fairly split bills and settle group expenses instantly." />

  <style>
    :root {
      --bg: #f5f5f5;
      --card: #ffffff;
      --text: #111111;
      --accent: #2563eb;
      --border: #dddddd;
      --toast: #111111;
    }

    body.dark {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #e5e7eb;
      --accent: #60a5fa;
      --border: #334155;
      --toast: #000000;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    body[dir="rtl"] {
      direction: rtl;
      text-align: right;
    }

    .container {
      max-width: 720px;
      margin: auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0;
      cursor: pointer;
    }

    button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    button.secondary {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .form {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    input {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 8px;
    }

    .actions button {
      padding: 4px 8px;
      font-size: 0.8rem;
    }

    ul {
      padding-inline-start: 20px;
    }

    #qr {
      margin-top: 12px;
      text-align: center;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--toast);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .toast.show {
      opacity: 0.9;
    }

    @media (max-width: 600px) {
      .form {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="container">

    <header>
      <h1 onclick="clearAll()">üí∏ <span id="title"></span></h1>
      <div>
        <button class="secondary" onclick="toggleLang()">üåê</button>
        <button class="secondary" onclick="toggleDark()">üåô</button>
      </div>
    </header>

    <div class="card">
      <div class="form">
        <input id="name" />
        <input id="amount" type="number" />
        <button onclick="addPerson()" id="addBtn"></button>
      </div>
    </div>

    <div class="card" id="peopleList"></div>

    <div class="card">
      <button class="secondary" onclick="copyLink()" id="shareBtn"></button>
      <button class="secondary" onclick="generateQR()" id="qrBtn"></button>
      <button class="secondary" onclick="clearAll()" id="clearBtn"></button>
      <button class="secondary" onclick="undoClear()" id="undoBtn" style="display:none"></button>

      <div id="output"></div>
      <div id="qr"></div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

<script>
/* ------------------ i18n ------------------ */
const dict = {
  en: {
    title: "SettleUp",
    name: "Name",
    paid: "Paid",
    add: "Add",
    people: "People",
    edit: "Edit",
    del: "Delete",
    eachPays: "Each pays",
    share: "Share",
    qr: "QR",
    clear: "Clear",
    undo: "Undo",
    scan: "Scan to open",
    linkCopied: "Link copied",
    confirmClear: "Clear all data?",
    cleared: "Cleared",
    restored: "Restored"
  },
  ar: {
    title: "ŸÇÿ≥ŸÖÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®",
    name: "ÿßŸÑÿßÿ≥ŸÖ",
    paid: "ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ",
    add: "ÿ•ÿ∂ÿßŸÅÿ©",
    people: "ÿßŸÑÿ£ÿ¥ÿÆÿßÿµ",
    edit: "ÿ™ÿπÿØŸäŸÑ",
    del: "ÿ≠ÿ∞ŸÅ",
    eachPays: "ŸÜÿµŸäÿ® ÿßŸÑŸÅÿ±ÿØ",
    share: "ŸÖÿ¥ÿßÿ±ŸÉÿ©",
    qr: "ÿ±ŸÖÿ≤ QR",
    clear: "ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ",
    undo: "ÿ™ÿ±ÿßÿ¨ÿπ",
    scan: "ÿßŸÖÿ≥ÿ≠ ŸÑŸÅÿ™ÿ≠ ÿßŸÑÿ±ÿßÿ®ÿ∑",
    linkCopied: "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",
    confirmClear: "ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü",
    cleared: "ÿ™ŸÖ ÿßŸÑŸÖÿ≥ÿ≠",
    restored: "ÿ™ŸÖÿ™ ÿßŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ©"
  }
};

function t(key) {
  return dict[currentLang][key];
}

/* ------------------ State ------------------ */
let people = [];
let editIndex = null;
let currentLang = "en";
let isDecoding = false;
let lastSnapshot = null;

/* ------------------ Elements ------------------ */
const nameInput = document.getElementById("name");
const amountInput = document.getElementById("amount");
const peopleList = document.getElementById("peopleList");
const output = document.getElementById("output");
const qr = document.getElementById("qr");
const toast = document.getElementById("toast");
const undoBtn = document.getElementById("undoBtn");

/* ------------------ UI ------------------ */
function applyLang() {
  document.body.dir = currentLang === "ar" ? "rtl" : "ltr";
  document.getElementById("title").textContent = t("title");
  nameInput.placeholder = t("name");
  amountInput.placeholder = t("paid");
  addBtn.textContent = t("add");
  shareBtn.textContent = t("share");
  qrBtn.textContent = t("qr");
  clearBtn.textContent = t("clear");
  undoBtn.textContent = t("undo");
  render();
  calculate();
}

/* ------------------ Utils ------------------ */
function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2500);
}

/* ------------------ Dark Mode ------------------ */
function toggleDark() {
  document.body.classList.toggle("dark");
  localStorage.setItem("dark", document.body.classList.contains("dark"));
}
if (localStorage.getItem("dark") === "true") toggleDark();

/* ------------------ Language ------------------ */
function toggleLang() {
  currentLang = currentLang === "en" ? "ar" : "en";
  applyLang();
  encodeState();
}

/* ------------------ URL State ------------------ */
function encodeState() {
  if (isDecoding || !people.length) return;
  const state = { v: 2, people, lang: currentLang };
  location.hash = "data=" + btoa(unescape(encodeURIComponent(JSON.stringify(state))));
}

function decodeState() {
  if (!location.hash.startsWith("#data=")) return;
  isDecoding = true;
  try {
    const decoded = JSON.parse(decodeURIComponent(escape(atob(location.hash.slice(6)))));
    people = decoded.people || [];
    currentLang = decoded.lang || "en";
  } catch {}
  isDecoding = false;
}
decodeState();
applyLang();

/* ------------------ CRUD ------------------ */
function addPerson() {
  const name = nameInput.value.trim();
  const amount = parseFloat(amountInput.value);
  if (!name || isNaN(amount)) return;

  people.push({ name, amount });

  nameInput.value = "";
  amountInput.value = "";

  render();
  calculate();
  encodeState();
}

function deletePerson(i) {
  people.splice(i, 1);
  render();
  calculate();
  encodeState();
}

/* ------------------ Render ------------------ */
function render() {
  peopleList.innerHTML = `<h3>${t("people")}</h3>`;
  people.forEach((p, i) => {
    peopleList.innerHTML += `
      <div class="list-item">
        <span>${p.name} ‚Äî ${p.amount}</span>
        <div class="actions">
          <button onclick="deletePerson(${i})">${t("del")}</button>
        </div>
      </div>`;
  });
}

/* ------------------ Calculation ------------------ */
function calculate() {
  if (!people.length) {
    output.innerHTML = "";
    return;
  }

  const total = people.reduce((s, p) => s + p.amount, 0);
  const share = +(total / people.length).toFixed(2);

  const bal = people.map(p => ({ name: p.name, b: +(p.amount - share).toFixed(2) }));
  const cred = bal.filter(x => x.b > 0);
  const debt = bal.filter(x => x.b < 0).map(x => ({ name: x.name, b: -x.b }));

  let i = 0, j = 0;
  let html = `<p><strong>${t("eachPays")}:</strong> ${share}</p>`;

  while (i < debt.length && j < cred.length) {
    const amt = Math.min(debt[i].b, cred[j].b);
    html += `<p>${debt[i].name} ‚Üí ${cred[j].name} : ${amt.toFixed(2)}</p>`;
    debt[i].b -= amt;
    cred[j].b -= amt;
    if (!debt[i].b) i++;
    if (!cred[j].b) j++;
  }

  output.innerHTML = html;
}

/* ------------------ Clear / Undo ------------------ */
function clearAll() {
  if (!people.length) return;
  if (!confirm(t("confirmClear"))) return;

  lastSnapshot = {
    people: JSON.parse(JSON.stringify(people)),
    lang: currentLang
  };

  people = [];
  output.innerHTML = "";
  qr.innerHTML = "";
  undoBtn.style.display = "inline-block";

  history.replaceState(null, "", location.pathname);
  render();
  showToast(t("cleared"));
}

function undoClear() {
  if (!lastSnapshot) return;

  people = lastSnapshot.people;
  currentLang = lastSnapshot.lang;
  lastSnapshot = null;

  undoBtn.style.display = "none";
  applyLang();
  encodeState();
  showToast(t("restored"));
}

/* ------------------ Share ------------------ */
function copyLink() {
  navigator.clipboard.writeText(location.href);
  showToast(t("linkCopied"));
}

function generateQR() {
  qr.innerHTML = `
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(location.href)}">
    <p>${t("scan")}</p>`;
}
</script>
</body>
</html>